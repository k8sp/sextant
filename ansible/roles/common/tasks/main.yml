---
- name: install package
  yum: 
    name: "{{ item }}"
    state: present 
  with_items:
    - [ docker-engine, etcd, flannel, make, kernel-devel, gcc, wget ]
  tags: yum

- name: mkdir dir
  file: 
    path: "{{ item }}"
    state: directory
    mode: 0755
    owner: root
  with_items:
    - /etc/kubernetes
    - /etc/kubernetes/ssl
  tags: k8s, tls

- name: copy kubernetes CA and key to k8s and docker
  copy: 
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 0600
    owner: root
    group: root
  with_items:
    - { src: tls/ca.pem, dest: /etc/kubernetes/ssl/ca.pem }
    - { src: tls/ca.pem, dest: "/etc/docker/certs.d/{{ docker_domain }}:5000/ca.crt" }
    - { src: tls/ca-key.pem, dest: /etc/kubernetes/ssl/ca-key.pem }
  tags: tls

- name: add docker domain local hosts 
  template:
    src: hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
  tags: hosts

# TODO: fix regexp
#- name: set flannel iterface option
#  lineinfile:
#    path: /etc/sysconfig/flanneld
#    regexp: '^FLANNEL_OPTIONS='
#    line: "FLANNEL_OPTIONS=\"-iface={{- ansible_default_ipv4.alias }}\""
#  tags: sysconfig 
